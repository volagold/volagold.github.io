---
title: All about SQL Queries
date: 2022-05-19 9:00:00 +0800
categories: [Programming]
tags: [sql, database]
image:
  src: /assets/imgs/sql.jpg
  alt: "All about SQL Queries"
  width: 800
  height: 500
math: true
published: false
toc: false
---

> this is a complete record of SQL queries.

* TOC
{:toc}

## Select the Data

### Select columns with `select ... from ...`

```sql
select c1, c2, ...
from tb
```

### Filter rows with `where`

```sql
select col1, col2, ...
from tb
where condition
    and/or [operator] col
    and/or â€¦
```

We can use *operators* in `where` conditions.

| Operator  | Description | Example|
| ---------------------- | ------------------------------------------- | ------------------------------------- |
| `=` | equal to    | `col = 'salary'`   |
| `<>` / `!=`| not equal to| `dept != 'decision'`|
| `>` | greater than| `date > 2022-02-15`|
| `<` | less than   | `price < 500.00`   |
| `>=`| greater than or equal    | `number >= 2`|
| `<=`| less than or equal| `number <= 2`|
| `and`| and  | `state = 'GA' and amount > 1000;`|
| `or`| or   | `state = 'GA' or amount > 1000;`|
| `[not] between`  | between an inclusive range| `price between 100.00 and 500.00`|
| `[not] like`| string pattern    | `name like 'Luca%'`|
| `ilike`   | string pattern, ignoring capitalization| `name like '%cafe%'`|
| `[not] in`| set membership test| `col in ('col1', 'col2', 'col3')`|
| `is [not] null`  | compare to null   | `address is not null`    |
| `is [not] true`  | boolean true value test  | `full_time is true`|
| `is not distinct from` | is equal to value or both are nulls   | `name is not distinct from full_name` |
| `as`| Rename table or column name. Can be omitted | `select result as r`|

### Filter rows with `distinct`, `order by` and `limit`

```sql
select distinct col1, col2, ... 
from tb 
where condition
order by col asc/desc
limit [num] offset [num]
```

>  note: `distinct` is slow.
{: .prompt-info }

### Categorize column values with `case when`

```sql
select 
...
case when [op1] col then output1
when [op2] col then output2
when [op3] col then output3
else ...
end (as col_name)
```

### Select columns from different tables with `join`

```sql
select col, col2, ...
from tb inner/left/right/full join tb2 on tb.id = tb2.id
where condition
...
```

tb

| id  | col   |
| --- | ----- |
| a   | value |
| b   | value |
| c   | value |
| d   | value |
| e   | value |

tb2

| id  | col2  |
| --- | ----- |
| a   | value |
| b   | value |
| x   | value |
| y   | value |

#### select row intersection with `inner`

`inner` means tb $\cap$ tb2.

| id  | col   | col2  |
| --- | ----- | ----- |
| a   | value | value |
| b   | value | value |

#### select rows from one table with `left` or `right`

`left` means tb.

| id  | col   | col2   |
| --- | ----- | ------ |
| a   | value | value  |
| b   | value | value  |
| c   | value | `null` |
| d   | value | `null` |
| e   | value | `null` |

`right` means tb2.

| id  | col    | col2  |
| --- | ------ | ----- |
| a   | value  | value |
| b   | value  | value |
| x   | `null` | value |
| y   | `null` | value |

#### select row union with `full`

`full` means tb $\cup$ tb2.

| id  | col    | col2   |
| --- | ------ | ------ |
| a   | value  | value  |
| b   | value  | value  |
| c   | value  | `null` |
| d   | value  | `null` |
| e   | value  | `null` |
| x   | `null` | value  |
| y   | `null` | value  |

> The `outer` keyword is deprecated. It is kept for backward compatibility with SQL-92 only.
{: .prompt-info }

> In real work you may use (inner) `join` most of the time. `left join` is not very efficient.
{: .prompt-info }

### Union all

```sql
select device_id, gender, age, gpa from user_profile where university = "Shandong University" 
union all
select device_id, gender, age, gpa from user_profile where gender = 'male' 
```

This query outputs the set of users that come from Shandong University, then users that are male, *in that order*. Instead,  in the output of this query

```sql
select device_id, gender, age, gpa 
from user_profile 
where university = "Shandong University" or gender = 'male'
```

users from Shandong University and users that are male are randomly mixed.

## Calculating statistics with aggregate functions

```sql
select agg(col) as ...
from tb
where condition
```

| function| description  |
| ------------ | ------------------------- |
| `count(col)` | counts the number of rows |
| `min(col)`   | min for all rows    |
| `max(col)`   | max for all rows    |
| `avg(col)`   | average for all rows|
| `sum(col)`   | sum of all rows|

### Apply aggregate funcitons to different groups of rows with `group by`

Instead of aggregating across ***all*** the rows, you can also apply the aggregate functions to different ***groups*** of rows with `group by`.

```sql
select agg(col) as ...
from tb
where condition
group by col
```

Rows are classified by labels in `col`. In other words, rows that correspond to the same label in `col` belong to the same group.

#### filter grouped rows with `having`

The `having` keyword is used to filter grouped rows returned by `group by`. If you do not use `group by`, then  a simple `where` clause will suffice.

```sql
group by col
having condition
```


> window functions may store information on a temperory database on disk, so their performance can be very slow. In many situations the old fashioned`group by` is way faster than window functins.
{: .prompt-info }

## Functions
### Date operators & functions

operators

| operator| meaning| example | result |
| ------------ | --------------------------------------------------- | ---------------------------------------------- | ------------------- |
| `+ int`| add a number of days to a date   | `select date '2021-08-14' + 1`    | 202-08-15|
| `+ interval` | add an interval to a date | `select date '2001-09-28' + interval '1 hour'` | 2001-09-28 01:00:00 |
| `+ time`| add a time-of-day to a date|   |  |
| `- int`| subtract a number of days from a date  |   |  |
| `- date`| subtract days, producing the number of days elapsed | `select date '2001-10-01' - date '2001-09-28'` | 3|
| `- time`| subtract times|   |  |

```sql
extract(unit from date)
```

unit: `microsecond`, `second`, `minute`, `hour`, `day`, `week`, `month`, `quarter`, `year`,

Different databases may have different date functions. For more, refer to the [documentation](https://www.postgresql.org/docs/current/functions-datetime.html) for a complete list of date functions.

| function    | description |
| ------------------------------ | ----------------- |
| `now()`| date and time now |
| `current_date`    | date now    |
| `current_time`    | time now    |
| `age(timestamp, timestap)`||
| `extract(unit from timestamp)` ||

### String operators & functions

Here we list some of the string functions in PostgreSQL. Refer to the [documentation](https://www.postgresql.org/docs/9.1/functions-string.html) for a complete list.

|function|description|example|result|
| ------ | ----- | ------- | -------- |
| `s || s`| string concatenation  | `'Post' || 'greSQL'`| PostgreSQL |
| `length(s)`|length of string|`length('jose')`|4|
| `lower(s)`| convert string to lower case | `lower('FEMALE')`| female|
| `upper(s)`| convert string to upper case | `upper('female')`| FEMALE|
| `position(sub in s)`| location of specified substring| `position('z' in 'wxyz')`  | 4|
| `substring(s from [int] for [int])`|extract substring| `substring('abcde' from 2 for 3)`| bcd  |
| `substring(s from [re])`| extract substring with regular expression | `substring('LxxxR xyz' from 'L.*R')`|LxxxR|
| `left(s, n)`| return fist n characters in the string. When $n$ is negative, return all but last $\vert n\vert$ characters. | `left('abcde', 2)`| ab|
| `right(s, n)`| return last $n$ characters in the string. | `right('vwxyz', 2)` | yz   |
| `replace(s, sub, repl)`| replace all occurences of substring | `replace('WakqSnake', 'ak', 'xx')` |WxxqSnxxe|
| `repeat(s, n)`   | repeat string $n$ times| `repeat('Pg', 4)`| PgPgPgPg|
| `string_to_array(s, delimiter)`| split string to array  | `select (string_to_array('165cm,55kg,26,female', ','))[4]` | female|

Related: [documentation on array functions](https://www.postgresql.org/docs/9.1/functions-array.html)


### Window functions

Sometime we need to append some calculated columns to the table. Window functions are used for this purpose.

```sql
select tb.*,fun(col) over (partition by col2 [order by col3]) as output_col
from tb
```

for `fun` can use

- aggregate functions (`max`, `min`, `sum`, etc.)

- ranking functions (`row_number`, `rank`, `dense_rank`, `ntile`).
  
  **It is useful for selecting the top (min or max) N records per category.**

- analytic functions (`lag`, `lead`)
  
  Access values of multiple rows in a window
  
  Compare multiple rows and calculate differences beteen rows

| function | meaning |
| -------- | ------- |
| `rank()` |   |
| `row_number()` |   |
| `dense_rank()` |   |
| `lead`   |   |
| `lag`|   |

<hr>
Cite as:

```bibtex
@article{lifei2022sql,
  title   = "{{ page.title }}",
  author  = "Li, Fei",
  journal = "www.lifei.tech",
  year    = "2022",
  url= "{{ page.url | absolute_url }}"
}
```
